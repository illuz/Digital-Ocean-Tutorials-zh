# 如何在 Ubuntu 14.04 中增加交换空间(Swap)

原文:[How To Add Swap on Ubuntu 14.04](https://www.digitalocean.com/community/tutorials/how-to-add-swap-on-ubuntu-14-04)

---

### 介绍

提高服务器的响应速度，防止应用程序内存不足的最简单方法就是添加一些交换空间。交换空间（Swap）是从硬盘中划分出来的一块区域，用来存放操作系统里内存中暂时不用的临时数据。

通常，交换空间在一些情况下能提高你服务器里可存储信息的容量，当内存容量不足时，这些硬盘上的空间就能起到作用了。

虽然硬盘上的数据读写比内存上的数据读写慢多了，不过操作系统会让运行中的程序优先跑在内存里，而交换空间里放些比较旧的数据。总体来说，在内存耗尽时把交换空间当作备用的存储容器是个可靠的处理方法。

在这个教程中，我们会学到如何在 Ubuntu 14.04 中创建并启用一个交换文件，增加交换空间。

#### 注意

一般来说，最好采用传统旋转硬盘系统来当交换空间，如果用 SSD 做交换空间，时间一长会加快硬件老化而出现各种问题。因此我们不建议在 DigitalOcean 或其它配 SSD 的服务器提供商的服务器上启用交换空间，这样做会你与你邻居的底层硬件的可用性。

如果你需要提高服务器的性能，我们建议升级你的 Droplet（DigitalOcean 的一个产品）。它能有效减少硬盘问题影响你的服务的可能性。

### 查看系统的交换信息

在开始前，我们要先看看我们的操作系统是否已经有配置了交换空间。虽然一个系统可以拥有多个交换文件或交换空间，不过一般一个就够用了。

看交换信息的一个途径是：

```sh
sudo swapon sh
# Filename                Type        Size    Used    Priority
```

如果只返回一行表格的头部信息，就像上面注释的那行，说明你现在没有开启任何交换空间。

另外一种检查途径是用 `free` 命令看系统的内存使用情况，我们可以通过输入下面的命令来查看系统当前的内存和交换空间情况：

```sh
free -m
#              total       used       free     shared    buffers     cached
# Mem:          3953        154       3799          0          8         83
# -/+ buffers/cache:         62       3890
# Swap:            0          0          0
```

像上面那样的返回信息说明这个系统的交换空间大小为 0。这跟第一种方法得到的结果是一致的。

### 查看磁盘分区的可用空间

分配交换空间的典型方式是单独使用一个分区来作为交换分区，不过我们并不总是可以去修改分区信息，有个很简单的方法就是在已有分区中创建交换文件。

在这之前我们要看看当前各个磁盘分区的可用空间：

```sh
df -h
# Filesystem      Size  Used Avail Use% Mounted on
# /dev/vda         59G  1.3G   55G   3% /
# none            4.0K     0  4.0K   0% /sys/fs/cgroup
# udev            2.0G   12K  2.0G   1% /dev
# tmpfs           396M  312K  396M   1% /run
# none            5.0M     0  5.0M   0% /run/lock
# none            2.0G     0  2.0G   0% /run/shm
# none            100M     0  100M   0% /run/user
```

从第一行可以看出我们的磁盘有 55G 的可用空间，所以我们可以选择这个分区。这里的信息来自一台中等配置的 VPS 机器，你自己机器的实际使用情况可能很不一样。

虽然有很多关于交换空间大小的意见，其实这还是取决于你的个人喜好和您的应用需求。一般情况下，系统内存一样的大小或双倍的大小都是不错的选择。

### 创建交换文件

现在已经决定好了可用的磁盘空间，就让我们开始创建交换文件吧。

接下来我们会在刚才选的根目录(/)创建一个名为 `swapfile` 文件，它的大小刚好是我们所要的交换空间的大小。有两个方法可以完成这一任务：

**1. 传统的方法，较慢：**

这个方法用到了 `dd` 这个用途广泛的磁盘工具，它能把数据从磁盘的一个地方写到另一个地方。

我们用 `dd` 从 /dev/zero 取出我们所需要量的 0 到 `swapfile` 文件中，/dev/zero 是 Linux 一个专门提供空字符的文件。

我们可以指定块大小(bs)和块的数量(count)来控制产生文件的大小，这两个参数的大小不是很重要，重要的是两个值相乘后的大小。 

在本文我们要创建一个 4G 大小的文件，我们可以让 bs=1G, count=4:

```sh
sudo dd if=/dev/zero of=/swapfile bs=1G count=4
# 4+0 records in
# 4+0 records out
# 4294967296 bytes (4.3 GB) copied, 18.6227 s, 231 MB/s
```

在按下回车前检查下你的命令有没有写错，因为这个命令会覆盖掉输出文件(of 参数所指的文件)。

我们可以用下面命令看看刚创建的那个文件：

```sh
ls -lh /swapfile
# -rw-r--r-- 1 root root 4.0G Apr 28 17:15 /swapfile
```

你刚才在执行命令的时候可能发现了，这个命令要运行好一段时间，在我机器上要运行 18 秒呢。这是因为这个命令刚才写了 4G 的 0 到磁盘上。

如果你想学招快一点的方法，先把刚创建的文件删了：

```sh
sudo rm /swapfile
```

**2. 更快的方法**

更快的方法是用 `fallocate` 工具，它能即时产生任意大小的预分配文件，而不用去写那些没必要的内容(0)。

我们来创建一个 4G 大小的文件：

```sh
sudo fallocate -l 4G /swapfile
```

执行后提示符立即就返回了，我们可以来验证一下创建的文件的大小：

```sh
ls -lh /swapfile
# -rw-r--r-- 1 root root 4.0G Apr 28 17:19 /swapfile
```

如你所见，我们的文件大小的正确的。

### 启用交换文件

现在，文件已经创建好了，不过系统并不懂这个文件是用作交换文件的，我们要告诉系统以 swap 的格式处理这个文件并启用它。

在这之前，我们还要调整下文件的权限，让它不能被 root 以外的其它人读到。不这样做的话其它用户如果可以对文件进行读写会有很大安全风险。我们通过以下命令来锁定权限：

```sh
sudo chmod 600 /swapfile
```

来验证下文件权限是否被设置成功：

```sh
ls -lh /swapfile
# -rw------- 1 root root 4.0G Apr 28 17:19 /swapfile
```

可以看到只有 root 的那一列立了读和写的 flag。

现在文件安全了，我们就可以让系统设置交换空间了：

```sh
sudo mkswap /swapfile
# Setting up swapspace version 1, size = 4194300 KiB
# no label, UUID=e2f1e9cf-c0a9-4ed4-b8ab-714b8a7d6944
```

我们的文件已经为交换空间做好准备了，可以启用它了：

```sh
sudo swapon /swapfile
```

现在来检查下系统的交换空间看看刚刚的步骤是否执行成功了：

```sh
sudo swapon -s
# Filename                Type        Size    Used    Priority
# /swapfile               file        4194300 0       -1
```

系统已经有了交换空间了，我们再用 `free` 工具检查一遍：

```sh
free -m
#              total       used       free     shared    buffers     cached
# Mem:          3953        101       3851          0          5         30
# -/+ buffers/cache:         66       3887
# Swap:         4095          0       4095
```

我们的交换空间成功配置了，系统会在需要的时候去使用它！

### 让交换文件一直启用

虽然现在已经启用了交换空间，不过重启之后机器并不会自动启用，因此我们要修改下 `fstab` 文件。

```sh
sudo nano /etc/fstab
```

在文件的后面加上一行让系统自动启用你创建的交换文件：

```sh
/swapfile   none    swap    sw    0   0
```

### 设置交换空间

你可以设置几个的交换空间的参数来控制系统的性能。

swappiness 参数决定了系统把内存的数据交换出来到交换空间中的频率，它的值是个百分比，范围从 0 到 100。

当值越接近 0，系统越不会在没必要时把内存数据交换进磁盘。记住，内存与交换空间进行数据交换的花费比内存间昂贵多了，过多的交换频率会让性能明显降低，所以不让系统过多的依赖交换空间可以使系统更快。

当值越接近 100，系统会把更多的数据放到交换空间中，给内存腾出更多的空闲空间。根据你的应用的内存配置或者你机器上服务的类型，在一些情况下值调大点可能会更好。

我们可以看看当前的 swappiness 值：

```sh
cat /proc/sys/vm/swappiness
# 60
```

如果在桌面系统中，把 swappiness 设置为 60 是不错的，不过在 VPS 服务器上，我们最好把它设置为尽量接近 0。

我们可以用 `sysctl` 命令设置 swappiness。

例如，把 swappiness 设置为 10：

```sh
sudo sysctl vm.swappiness=10
# vm.swappiness = 10
```

这个设置的效果会持续到下次重启，我们可以让电脑每次开机自动设置这个值，打开 /etc/sysctl.conf 文件：

```sh
sudo nano /etc/sysctl.conf
```

然后在最下面加一行：

```
vm.swappiness=10
```

你可能会修改的另外一个参数是 vfs_cache_pressure，决定了系统回收缓存 inode 和目录文件项(dentry)的倾向。

文件系统访问数据是很昂贵而且频繁的，所以缓存是件好事件。你可以看看当前的 vfs_cache_pressure 值：

```sh
cat /proc/sys/vm/vfs_cache_pressure
# 100
```

根据返回的配置值，当前系统回收缓存里的 inode 频率太快了，所以我们把它设置得保守点，设置成 50:

```sh
sudo sysctl vm.vfs_cache_pressure=50
# vm.vfs_cache_pressure = 50
```

同样，这个设置的效果只会持续到下次重启，跟 swappiness 参数一样，我们也配置下 /etc/sysctl.conf 文件。

```sh
sudo nano /etc/sysctl.conf
```

然后在最下面加一行：

```
vm.vfs_cache_pressure = 50
```

### 总结

跟着这篇指南做完后，你的内存使用时就会有一些喘息的空间。交换空间在避免一些常见问题时非常有用。

如果你遇到了 OOM(out of memory) 错误，或者你发现系统不能打开想打开的应用，最好的解决方法是优化你的应用程序，或者升级你的机器。不过，通过配置交换空间，你可以更灵活的解决这些问题，而且还能省下些时间与金钱。


(已完)
